import{h as t,r as e,H as n}from"./p-717250b8.js";import{c as r,a as i,b as o}from"./p-7d5dbd9a.js";import{T as s,a,b as u}from"./p-2ece7dd7.js";import{u as c,s as h}from"./p-34b40baa.js";import{_ as l}from"./p-1f8fb40c.js";function f(t){return t}function d(t){return function(){return t}}function m(t,e,n,r,i,o,s,a,u,c,h,l,f,d,m,p,v,b,w,y){switch(arguments.length){case 1:return t;case 2:return e(t);case 3:return n(e(t));case 4:return r(n(e(t)));case 5:return i(r(n(e(t))));case 6:return o(i(r(n(e(t)))));case 7:return s(o(i(r(n(e(t))))));case 8:return a(s(o(i(r(n(e(t)))))));case 9:return u(a(s(o(i(r(n(e(t))))))));case 10:return c(u(a(s(o(i(r(n(e(t)))))))));case 11:return h(c(u(a(s(o(i(r(n(e(t))))))))));case 12:return l(h(c(u(a(s(o(i(r(n(e(t)))))))))));case 13:return f(l(h(c(u(a(s(o(i(r(n(e(t))))))))))));case 14:return d(f(l(h(c(u(a(s(o(i(r(n(e(t)))))))))))));case 15:return m(d(f(l(h(c(u(a(s(o(i(r(n(e(t))))))))))))));case 16:return p(m(d(f(l(h(c(u(a(s(o(i(r(n(e(t)))))))))))))));case 17:return v(p(m(d(f(l(h(c(u(a(s(o(i(r(n(e(t))))))))))))))));case 18:return b(v(p(m(d(f(l(h(c(u(a(s(o(i(r(n(e(t)))))))))))))))));case 19:return w(b(v(p(m(d(f(l(h(c(u(a(s(o(i(r(n(e(t))))))))))))))))));case 20:return y(w(b(v(p(m(d(f(l(h(c(u(a(s(o(i(r(n(e(t)))))))))))))))))))}}var p=function(t){return"Left"===t._tag},v=function(t){return"Right"===t._tag},b=function(t){return{_tag:"Left",left:t}},w=function(t){return{_tag:"Right",right:t}};function y(t,e){return function(n){return p(n)?t(n.left):e(n.right)}}function g(t){return p(t)?w(t.left):b(t.right)}var x=function(t){return"Some"===t._tag},$={_tag:"None"},E=function(t){return{_tag:"Some",value:t}};const S={_tag:"Initial"},j={_tag:"Pending"},A=t=>({_tag:"Refresh",value:t}),D=t=>({_tag:"Replete",value:t}),T=d(S),P=d(j),R=(t,e,n,r)=>i=>{switch(i._tag){case"Initial":return t();case"Pending":return e();case"Refresh":return n(i.value);case"Replete":return r(i.value)}},k=t=>"Pending"===t._tag,O=t=>"Refresh"===t._tag,I=t=>(t=>"Replete"===t._tag)(t)||O(t),C=(t,e)=>R(T,P,(t=>A(e(t))),(t=>D(e(t))))(t),N=t=>R(T,P,(t=>x(t)?A(t.value):S),(t=>x(t)?D(t.value):S))(t),U={left:S,right:S},M=t=>{const e=C(t,(t=>({left:p(t)?D(t.left):S,right:v(t)?D(t.right):S})));return(n=()=>U,r=()=>U,t=>R(n,r,f,f)(t))(e);var n,r},q=(t,e)=>R(T,P,(n=>e(n)?t:S),(n=>e(n)?t:S))(t);var L,z;Object.assign(Object.assign({},{map:function(t,e){return L.map(t,function(t){return function(e){return p(e)?e:w(t(e.right))}}(e))},ap:function(t,e){return m(t,(n=e,function(t){return L.ap(L.map(t,(function(t){return function(e){return m(t,function(t){return function(e){return p(e)?e:p(t)?t:w(e.right(t.right))}}(e))}})),n)}));var n},of:z=function(t,e,n,r,i,o,s,a,u){switch(arguments.length){case 1:return t;case 2:return function(){return e(t.apply(this,arguments))};case 3:return function(){return n(e(t.apply(this,arguments)))};case 4:return function(){return r(n(e(t.apply(this,arguments))))};case 5:return function(){return i(r(n(e(t.apply(this,arguments)))))};case 6:return function(){return o(i(r(n(e(t.apply(this,arguments))))))};case 7:return function(){return s(o(i(r(n(e(t.apply(this,arguments)))))))};case 8:return function(){return a(s(o(i(r(n(e(t.apply(this,arguments))))))))};case 9:return function(){return u(a(s(o(i(r(n(e(t.apply(this,arguments)))))))))}}}(w,(L={URI:"@nll/datum/Datum",map:C,of:D,ap:(t,e)=>R(T,(()=>R(T,P,P,P)(e)),(t=>R(T,P,(e=>A(t(e))),(e=>A(t(e))))(e)),(t=>R(T,P,(e=>A(t(e))),(e=>D(t(e))))(e)))(t),chain:(t,e)=>R(T,P,e,e)(t),reduce:(t,e,n)=>R((()=>e),(()=>e),(t=>n(e,t)),(t=>n(e,t)))(t),foldMap:t=>(e,n)=>R((()=>t.empty),(()=>t.empty),n,n)(e),reduceRight:(t,e,n)=>R((()=>e),(()=>e),(t=>n(t,e)),(t=>n(t,e)))(t),traverse:t=>(e,n)=>R((()=>t.of(S)),(()=>t.of(j)),(e=>t.map(n(e),A)),(e=>t.map(n(e),D)))(e),sequence:t=>e=>R((()=>t.of(S)),(()=>t.of(j)),(e=>t.map(e,A)),(e=>t.map(e,D)))(e),zero:T,alt:(t,e)=>R(e,e,A,D)(t),extend:(t,e)=>D(e(t)),compact:N,separate:M,filter:q,filterMap:(t,e)=>N(C(t,e)),partition:(t,e)=>({left:q(t,(t=>!e(t))),right:q(t,e)}),partitionMap:(t,e)=>M(C(t,e)),wither:t=>(e,n)=>R(d(t.of(S)),d(t.of(j)),(e=>t.map(n(e),(t=>x(t)?A(t.value):S))),(e=>t.map(n(e),(t=>x(t)?D(t.value):S))))(e),wilt:t=>(e,n)=>{const r=C(e,(e=>t.map(n(e),(t=>({left:p(t)?D(t.left):S,right:v(t)?D(t.right):S})))));return I(r)?r.value:t.of(U)},throwError:()=>S}).of),chain:function(t,e){return L.chain(t,(function(t){return p(t)?L.of(b(t.left)):e(t.right)}))},alt:function(t,e){return L.chain(t,(function(t){return p(t)?e():z(t.right)}))},bimap:function(t,e,n){return L.map(t,(function(t){return m(t,function(t,e){return function(n){return p(n)?b(t(n.left)):w(e(n.right))}}(e,n))}))},mapLeft:function(t,e){return L.map(t,(function(t){return m(t,function(t){return function(e){return p(e)?b(t(e.left)):e}}(e))}))},fold:function(t,e,n){return L.chain(t,y(e,n))},getOrElse:function(t,e){return L.chain(t,y(e,L.of))},orElse:function(t,e){return L.chain(t,y(e,(function(t){return z(t)})))},swap:function(t){return L.map(t,g)},rightM:function(t){return L.map(t,w)},leftM:function(t){return L.map(t,b)},left:function(t){return L.of(b(t))}}),{URI:"@nll/datum/DatumEither"});const F=t=>D(w(t)),_=t=>D(b(t)),J=S,B=j,W=()=>J,G=()=>B,H=t=>I(t)&&v(t.value),V=t=>I(t)&&p(t.value),K=t=>R(G,G,d(t),A)(t),X=t=>R(W,W,D,d(t))(t),Y=(t,e,n,r,i,o)=>s=>{switch(s._tag){case"Initial":return t();case"Pending":return e();case"Refresh":return y(n,r)(s.value);case"Replete":return y(i,o)(s.value)}};r((function(t,e){var n=function(t){function e(){this.fetch=!1,this.DOMException=t.DOMException}return e.prototype=t,new e}("undefined"!=typeof self?self:i);!function(t){!function(e){var n="URLSearchParams"in t,r="Symbol"in t&&"iterator"in Symbol,i="FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(ot){return!1}}(),o="FormData"in t,s="ArrayBuffer"in t;if(s)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(t){return t&&a.indexOf(Object.prototype.toString.call(t))>-1};function c(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function h(t){return"string"!=typeof t&&(t=String(t)),t}function l(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return r&&(e[Symbol.iterator]=function(){return e}),e}function f(t){this.map={},t instanceof f?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function d(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function m(t){return new Promise((function(e,n){t.onload=function(){e(t.result)},t.onerror=function(){n(t.error)}}))}function p(t){var e=new FileReader,n=m(e);return e.readAsArrayBuffer(t),n}function v(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function b(){return this.bodyUsed=!1,this._initBody=function(t){var e;this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:i&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:o&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:n&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():s&&i&&(e=t)&&DataView.prototype.isPrototypeOf(e)?(this._bodyArrayBuffer=v(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):s&&(ArrayBuffer.prototype.isPrototypeOf(t)||u(t))?this._bodyArrayBuffer=v(t):this._bodyText=t=Object.prototype.toString.call(t):this._bodyText="",this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},i&&(this.blob=function(){var t=d(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?d(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(p)}),this.text=function(){var t,e,n,r=d(this);if(r)return r;if(this._bodyBlob)return t=this._bodyBlob,n=m(e=new FileReader),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),r=0;r<e.length;r++)n[r]=String.fromCharCode(e[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},o&&(this.formData=function(){return this.text().then(g)}),this.json=function(){return this.text().then(JSON.parse)},this}f.prototype.append=function(t,e){t=c(t),e=h(e);var n=this.map[t];this.map[t]=n?n+", "+e:e},f.prototype.delete=function(t){delete this.map[c(t)]},f.prototype.get=function(t){return t=c(t),this.has(t)?this.map[t]:null},f.prototype.has=function(t){return this.map.hasOwnProperty(c(t))},f.prototype.set=function(t,e){this.map[c(t)]=h(e)},f.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},f.prototype.keys=function(){var t=[];return this.forEach((function(e,n){t.push(n)})),l(t)},f.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),l(t)},f.prototype.entries=function(){var t=[];return this.forEach((function(e,n){t.push([n,e])})),l(t)},r&&(f.prototype[Symbol.iterator]=f.prototype.entries);var w=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function y(t,e){var n,r,i=(e=e||{}).body;if(t instanceof y){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new f(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"same-origin",!e.headers&&this.headers||(this.headers=new f(e.headers)),this.method=(r=(n=e.method||this.method||"GET").toUpperCase(),w.indexOf(r)>-1?r:n),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function g(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var n=t.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");e.append(decodeURIComponent(r),decodeURIComponent(i))}})),e}function x(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new f(e.headers),this.url=e.url||"",this._initBody(t)}y.prototype.clone=function(){return new y(this,{body:this._bodyInit})},b.call(y.prototype),b.call(x.prototype),x.prototype.clone=function(){return new x(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},x.error=function(){var t=new x(null,{status:0,statusText:""});return t.type="error",t};var $=[301,302,303,307,308];x.redirect=function(t,e){if(-1===$.indexOf(e))throw new RangeError("Invalid status code");return new x(null,{status:e,headers:{location:t}})},e.DOMException=t.DOMException;try{new e.DOMException}catch(S){e.DOMException=function(t,e){this.message=t,this.name=e;var n=Error(t);this.stack=n.stack},e.DOMException.prototype=Object.create(Error.prototype),e.DOMException.prototype.constructor=e.DOMException}function E(t,n){return new Promise((function(r,o){var s=new y(t,n);if(s.signal&&s.signal.aborted)return o(new e.DOMException("Aborted","AbortError"));var a=new XMLHttpRequest;function u(){a.abort()}a.onload=function(){var t,e,n={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new f,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(t){var n=t.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();e.append(r,i)}})),e)};n.url="responseURL"in a?a.responseURL:n.headers.get("X-Request-URL"),r(new x("response"in a?a.response:a.responseText,n))},a.onerror=function(){o(new TypeError("Network request failed"))},a.ontimeout=function(){o(new TypeError("Network request failed"))},a.onabort=function(){o(new e.DOMException("Aborted","AbortError"))},a.open(s.method,s.url,!0),"include"===s.credentials?a.withCredentials=!0:"omit"===s.credentials&&(a.withCredentials=!1),"responseType"in a&&i&&(a.responseType="blob"),s.headers.forEach((function(t,e){a.setRequestHeader(e,t)})),s.signal&&(s.signal.addEventListener("abort",u),a.onreadystatechange=function(){4===a.readyState&&s.signal.removeEventListener("abort",u)}),a.send(void 0===s._bodyInit?null:s._bodyInit)}))}E.polyfill=!0,t.fetch||(t.fetch=E,t.Headers=f,t.Request=y,t.Response=x),e.Headers=f,e.Request=y,e.Response=x,e.fetch=E}({})}(n),delete n.fetch.polyfill,(e=n.fetch).default=n.fetch,e.fetch=n.fetch,e.Headers=n.Headers,e.Request=n.Request,e.Response=n.Response,t.exports=e}));var Q=null;"undefined"!=typeof WebSocket?Q=WebSocket:"undefined"!=typeof MozWebSocket?Q=MozWebSocket:void 0!==i?Q=i.WebSocket||i.MozWebSocket:"undefined"!=typeof window?Q=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(Q=self.WebSocket||self.MozWebSocket);var Z=Q;class tt extends String{constructor(t,e){super(e),this.family=t}}const et=((t,e,n)=>{let r=(2<<Math.log(t.length-1)/Math.LN2)-1,i=-~(1.6*r*20/t.length);return()=>{let e="";for(;;){let o=n(i),s=i;for(;s--;)if(e+=t[o[s]&r]||"",20===e.length)return e}}})("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",0,(t=>crypto.getRandomValues(new Uint8Array(t))));var nt,rt;function it(t){const e=2===t.length?t:0===t.length?"uu":1===t.length?t.repeat(2):t.slice(0,2),n=(Date.now()-15e11).toString(16).padStart(10,"0"),r=et();return new tt(e,`${e}.${n}.${r}`)}function ot(){return(ot=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}if("undefined"!=typeof process&&(nt={emit:process.emit,listeners:process.listeners,addListener:process.addListener,removeListener:process.removeListener,removeAllListeners:process.removeAllListeners}),"undefined"!=typeof window){var st=new Map;nt={emit:function(t,e){window.dispatchEvent(new CustomEvent(t,{detail:e}))},listeners:function(){return Array.from(st.keys())},addListener:function(t,e){var n=function(t){return e(t.detail)};window.addEventListener(t,n),st.set(e,n)},removeListener:function(t,e){var n=st.get(e);void 0!==n&&(window.removeEventListener(t,n),st.delete(e))},removeAllListeners:function(t){Array.from(st.values()).map((function(e){window.removeEventListener(t,e)})),st.clear()}}}function at(t,e,n){var r="";"object"==typeof t&&void 0!==t.message?r=t.message:"string"==typeof t&&(r=t);var i={tag:e,level:n,message:r};if("object"==typeof t&&void 0!==t.stack)i.stack=t.stack;else if(n<=rt.error){var o=new Error;if(void 0!==o.stack){var s=o.stack.split("\n");i.stack=[s[0]].concat(s.slice(3)).join("\n")}}nt.emit("stencila:logga",i)}!function(t){t[t.error=0]="error",t[t.warn=1]="warn",t[t.info=2]="info",t[t.debug=3]="debug"}(rt||(rt={}));var ut=new Map;function ct(t){return{error:function(e){at(e,t,rt.error)},warn:function(e){at(e,t,rt.warn)},info:function(e){at(e,t,rt.info)},debug:function(e){at(e,t,rt.debug)}}}0===nt.listeners("stencila:logga").length&&function(t,e){void 0===e&&(e={});var n=t,r=e.tags,i=e.maxLevel,o=e.messageRegex,s=e.func;void 0===r&&void 0===i&&void 0===o&&void 0===s||(n=function(e){(void 0===r||r.includes(e.tag))&&(void 0!==i&&e.level>i||(void 0===o||o.test(e.message))&&(void 0===s||s(e))&&t(e))}),nt.addListener("stencila:logga",n)}((function(t,e){void 0===e&&(e={});var n=t.tag,r=t.level,i=t.message,o=t.stack,s=e.maxLevel;if(!(r>(void 0===s?rt.info:s))){var a=e.throttle;if(void 0!==a){var u=(void 0!==a.signature?a.signature:"").replace(/\${tag}/,n).replace(/\${level}/,r.toString()).replace(/\${message}/,i),c=ut.get(u);if(void 0!==c){var h=void 0!==a.duration?a.duration:1e3;if(Date.now()-c<h)return}ut.set(u,Date.now())}var l="";if("undefined"!=typeof process&&void 0!==process.stderr&&!0!==process.stderr.isTTY)l=JSON.stringify(ot({time:(new Date).toISOString()},t));else{var f=r<0?0:r>3?3:r,d=rt[f].toUpperCase().padEnd(5," ");l="undefined"!=typeof window?d+" "+n+" "+i:["üö®","‚ö†","üõà","üêõ"][f]+" "+["[31;1m","[33;1m","[34;1m","[30;1m"][f]+d+"[0m [36m"+n+"[0m "+i;var m=e.showStack;void 0!==m&&m&&void 0!==o&&(l+="\n  "+o)}console.error(l)}}));var ht=function(t){var e;return function(t){return function(e){return!!lt(e)&&function(t){return function(e){return Object.keys(t).includes(e)}}(t)(e.type)}}(((e={})[t]=t,e))},lt=function(t){return null!=t&&Object.prototype.hasOwnProperty.call(t,"type")};ht("Article"),ht("Paragraph"),ht("ListItem");class ft extends Error{constructor(t){super(t),this.name="InternalError"}}class dt extends Error{constructor(t){super(`Method "${t}" is unknown`),this.name="MethodUnknownError",this.method=t}}class mt extends Error{constructor(t){super(`Parameter "${t}" is required`),this.name="ParamRequiredError",this.param=t}}class pt extends Error{constructor(t="Incapable",e,n={}){super(void 0!==e?pt.message(t,e,n):t),this.name="CapabilityError"}static message(t,e,n){return`${t}: method "${e}" with params:\n`+Object.entries(n).map((([t,e])=>{let n;return lt(e)?n=`<${function(t){return null===t?"Null":"boolean"==typeof t?"Boolean":"number"==typeof t?"Number":"string"==typeof t?"Text":Array.isArray(t)?"Array":lt(t)?t.type:"Object"}(e)}>`:(n=JSON.stringify(e),void 0!==n&&n.length>20&&(n=n.slice(0,20)+"...")),`  ${t}: ${n}`})).join("\n")}}const vt=ct("executa:executor");var bt,wt,yt;!function(t){t.manifest="manifest",t.decode="decode",t.encode="encode",t.query="query",t.compile="compile",t.build="build",t.execute="execute",t.begin="begin",t.end="end",t.pipe="pipe",t.cancel="cancel"}(bt||(bt={})),function(t){t.direct="direct",t.stdio="stdio",t.pipe="pipe",t.uds="uds",t.vsock="vsock",t.tcp="tcp",t.http="http",t.ws="ws"}(wt||(wt={}));class gt extends class extends class{constructor(t,e={scheme:"tcp",host:"127.0.0.1",port:7e3}){this.type=wt.tcp;const{scheme:n,host:r,port:i}=xt(t,e);this.scheme=n,this.host=r,this.port=i}url(){return function(t){const{scheme:e,host:n,port:r,path:i}=t;let o=`${e}://${n}`;return"tcp"!==e&&("http"!==e&&"ws"!==e||80===r)&&("https"!==e&&"wss"!==e||443===r)||(o+=":"+r),"tcp"!==e&&void 0!==i&&(i.startsWith("/")||(o+="/"),o+=i),o}(this)}}{constructor(t,e={scheme:"http",host:"127.0.0.1",port:80}){super(t,e),this.type=wt.http;const{path:n}=xt(t,e);if(this.path=n,"object"==typeof t){const{protocol:e,jwt:n}=t;this.protocol=e,this.jwt=n}}}{constructor(t){super(t,{scheme:"ws",host:"127.0.0.1",port:80}),this.type=wt.ws}}function xt(t,e){let n,{scheme:r,host:i,path:o}={path:void 0,...e};if("string"==typeof t){const e=/^[0-9]{2,5}$/.exec(t);if(null!==e)n=parseInt(e[0]);else{const e=/(([a-z]{2,5}):\/\/)?([^:/]+)(:(\d+))?(\/(.+))?$/.exec(t);if(null===e)throw new ft(`Could not parse address "${t}"`);void 0!==e[2]&&(r=e[2]),void 0!==e[3]&&(i=e[3]),void 0!==e[5]&&(n=parseInt(e[5])),void 0!==e[7]&&(o=e[7])}}else"number"==typeof t?n=t:({scheme:r,host:i,port:n,path:o}={scheme:r,host:i,port:n,path:o,...t});return void 0===n&&(n="http"===r||"ws"===r?80:"https"===r||"wss"===r?443:e.port),{scheme:r,host:i,port:n,path:o}}!function(t){t[t.ParseError=-32700]="ParseError",t[t.InvalidRequest=-32600]="InvalidRequest",t[t.MethodNotFound=-32601]="MethodNotFound",t[t.InvalidParams=-32602]="InvalidParams",t[t.InternalError=-32603]="InternalError",t[t.ServerError=-32e3]="ServerError",t[t.CapabilityError=-32005]="CapabilityError"}(yt||(yt={}));class $t{constructor(t,e,n){this.name="JsonRpcError",this.code=t,this.message=e,this.data=n}static fromError(t){return t instanceof $t?t:t instanceof dt?new $t(yt.MethodNotFound,`Method not found: "${t.method}"`):t instanceof mt?new $t(yt.InvalidParams,`Invalid params: "${t.param}" is missing`):t instanceof pt?new $t(yt.CapabilityError,t.message):new $t(yt.ServerError,"Internal error: "+t.message,{trace:t.stack})}static toError(t){const{code:e,message:n}=t;switch(e){case yt.CapabilityError:return new pt(n);default:return t}}}class Et{constructor(t,e,n){this.jsonrpc="2.0",void 0!==n&&!1!==n?this.id=n:void 0===n&&(this.id=it("re").toString()),this.method=t,this.params=e}static create(t){if("string"==typeof t)return Et.parse(t);if(null!==t&&"object"==typeof t&&!Array.isArray(t))return Et.hydrate(t);throw new $t(yt.InvalidRequest,"Invalid request type: "+typeof t)}static hydrate(t){const{method:e,params:n,id:r}=t;if(void 0===e)throw new $t(yt.InvalidRequest,'Invalid request: missing property: "method"');if("string"!=typeof e)throw new $t(yt.InvalidRequest,'Invalid request: incorrect type for "method": '+typeof e);return new Et(e,n,void 0!==r&&r)}static parse(t){let e;try{e=JSON.parse(t)}catch(n){throw new $t(yt.ParseError,"Parse error: "+n.message)}return Et.hydrate(e)}}const St=ct("executa:client");function jt(t,e){"boolean"==typeof e&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var At=jt;jt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},jt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},jt.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=(new Date).getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),n=this._timeouts.shift()}var r=this,i=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n);return this._options.unref&&i.unref(),!0},jt.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},jt.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)},jt.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)},jt.prototype.start=jt.prototype.try,jt.prototype.errors=function(){return this._errors},jt.prototype.attempts=function(){return this._attempts},jt.prototype.mainError=function(){if(0===this._errors.length)return null;for(var t={},e=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],o=i.message,s=(t[o]||0)+1;t[o]=s,s>=n&&(e=i,n=s)}return e};var Dt,Tt,Pt=((Tt=(Dt={exports:{}}).exports).operation=function(t){var e=Tt.timeouts(t);return new At(e,{forever:t&&t.forever,unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},Tt.timeouts=function(t){if(t instanceof Array)return[].concat(t);var e={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in t)e[n]=t[n];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],i=0;i<e.retries;i++)r.push(this.createTimeout(i,e));return t&&t.forever&&!r.length&&r.push(this.createTimeout(i,e)),r.sort((function(t,e){return t-e})),r},Tt.createTimeout=function(t,e){var n=e.randomize?Math.random()+1:1,r=Math.round(n*e.minTimeout*Math.pow(e.factor,t));return Math.min(r,e.maxTimeout)},Tt.wrap=function(t,e,n){if(e instanceof Array&&(n=e,e=null),!n)for(var r in n=[],t)"function"==typeof t[r]&&n.push(r);for(var i=0;i<n.length;i++){var o=n[i];t[o]=function(n){var r=Tt.operation(e),i=Array.prototype.slice.call(arguments,1),o=i.pop();i.push((function(t){r.retry(t)||(t&&(arguments[0]=r.mainError()),o.apply(this,arguments))})),r.attempt((function(){n.apply(t,i)}))}.bind(t,t[o]),t[o].options=e}},Dt.exports);class Rt extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,({message:t}=t)):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}}const kt=(t,e)=>new Promise(((n,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const i=Pt.operation(e);i.attempt((async o=>{try{n(await t(o))}catch(s){if(!(s instanceof Error))return void r(new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`));if(s instanceof Rt)i.stop(),r(s.originalError);else if(s instanceof TypeError)i.stop(),r(s);else{((t,e,n)=>{const r=n.retries-(e-1);t.attemptNumber=e,t.retriesLeft=r})(s,o,e);try{await e.onFailedAttempt(s)}catch(s){return void r(s)}i.retry(s)||r(i.mainError())}}}))}));var Ot=kt,It=Rt;Ot.default=kt,Ot.AbortError=It;const Ct=ct("executa:ws:client"),Nt={logging:!0,timeout:60,retries:10};class Ut extends class extends class{constructor(t="ex"){this.id=it(t).toString()}addresses(){return Promise.resolve(void 0)}capabilities(){return Promise.resolve(void 0)}async manifest(){return{version:1,id:this.id.toString(),addresses:await this.addresses(),capabilities:await this.capabilities()}}decode(t,e){return this.call(bt.decode,{source:t,format:e})}encode(t,e,n){return this.call(bt.encode,{node:t,dest:e,format:n})}query(t,e,n){return this.call(bt.query,{node:t,query:e,lang:n})}compile(t){return this.call(bt.compile,{node:t})}build(t){return this.call(bt.build,{node:t})}execute(t,e,n,r){return this.call(bt.execute,{node:t,session:e,claims:n,job:r})}begin(t,e){return this.call(bt.begin,{node:t,claims:e})}end(t,e){return this.call(bt.end,{node:t,claims:e})}pipe(t,e){return this.call(bt.pipe,{node:t,calls:e})}cancel(t){return Promise.resolve(!1)}dispatch(t,e={}){switch(t){case bt.manifest:return this.manifest();case bt.decode:return this.decode(n(0,"source"),n(1,"format",!1));case bt.encode:return this.encode(n(0,"node"),n(1,"dest",!1),n(2,"format",!1));case bt.query:return this.query(n(0,"node"),n(1,"query"),n(1,"lang",!1));case bt.compile:return this.compile(n(0,"node"));case bt.build:return this.build(n(0,"node"));case bt.execute:return this.execute(n(0,"node"),n(1,"session",!1),n(2,"claims",!1),n(3,"job",!1));case bt.begin:return this.begin(n(0,"node"),n(1,"claims",!1));case bt.end:return this.end(n(0,"node"),n(1,"claims",!1));case bt.pipe:return this.pipe(n(0,"node"),n(1,"calls"));case bt.cancel:return this.cancel(n(0,"job"))}throw new dt(t);function n(t,n,r=!0){let i=e[n];if(void 0===i&&(i=e[t]),r&&void 0===i)throw new mt(n);return i}}call(t,e){throw new pt("No capability implemented",t,e)}notify(t,e,n,r){throw new ft("Method notify should be implemented in derived classes")}notified(t,e,n){switch(t){case"debug":case"info":case"warn":case"error":vt[t](e);break;default:vt.info(e)}}start(){return Promise.resolve()}stop(){return Promise.resolve()}}{constructor(t="cli"){super(t),this.requests={},this.notifications=[],this.notificationsCount=0,this.notificationsLength=1e3}async manifest(){return void 0===this.manifestCached&&(this.manifestCached=await this.call(bt.manifest)),this.manifestCached}cancel(t){return this.call(bt.cancel,{job:t})}async call(t,e={}){const n=new Et(t,e),r=n.id;if(void 0===r)throw new ft("Request should have id defined");const i=new Promise(((t,e)=>{this.requests[r]={id:r,date:new Date,resolve:t,reject:e}}));return await this.send(n),i}notify(t,e){const n=new Et(t,{message:e},!1);return this.send(n)}notified(t,e){const{notifications:n,notificationsLength:r}=this;this.notificationsCount+=1,n.push({id:this.notificationsCount,date:new Date,subject:t,message:e}),n.length>r&&n.splice(0,n.length-r)}receive(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(s){return void St.error("Error parsing message as JSON: "+t)}const{id:e}=t;if(void 0===e){const{method:e,params:n=[]}=t,r=Object.values(n);return this.notified(e,r[0])}if(0===e.length)return void St.error("Response is missing id: "+JSON.stringify(t));const n=this.requests[e];if(void 0===n)return void St.error("No request found for response with id: "+e);const{resolve:r,reject:i}=n,{result:o,error:s}=t;if(null!=s)i($t.toError(s));else try{r(o)}catch(s){St.error("Unhandled error when resolving result: "+s)}delete this.requests[e]}stop(){for(const{reject:t}of Object.values(this.requests))t(new Error("Client is stopping"));return super.stop()}}{constructor(t=new gt,e=Nt){super("ws"),this.stopped=!1,this.address=new gt(t),this.options={...Nt,...e}}start(){const{id:t,address:e,options:{retries:n,logging:r}}=this,i=this.socket=new Z(e.url(),function(t,e){return"executa.stenci.la+1+"+t+(void 0!==e?"+"+e:"")}(t,e.jwt));return i.onmessage=t=>this.receive(t.data.toString()),i.onclose=t=>{if(!0===this.stopped)return;const{code:e,reason:i}=t;4001!==e?n>0&&(r&&Ct.info("Connection closed, trying to reconnect"),Ot((()=>this.start()),{retries:n,randomize:!0}).catch((t=>Ct.error(t)))):r&&Ct.error("Failed to authenticate with server: "+i)},i.onerror=t=>{r&&Ct.error(t.message)},this.stopped=!1,Promise.resolve()}async send(t){const{socket:e,options:{timeout:n}}=this;return void 0===e?(await this.start(),this.send(t)):async function(t,e,n=60){return await function(t,e=60){if(function(t){return t.readyState===Z.CLOSING||t.readyState===Z.CLOSED}(t))throw new Error("WebSocket is closing or closed");return t.readyState!==Z.OPEN?new Promise(((n,r)=>{let i=!1;t.onopen=()=>{i=!0,n()},setTimeout((()=>{i||r(new Error("WebSocket timeout"))}),1e3*e)})):Promise.resolve()}(t,n),t.send(e),Promise.resolve()}(e,JSON.stringify(t),n)}receive(t){const{socket:e,options:{logging:n}}=this;void 0!==e&&(function(t){return t.readyState===Z.OPEN}(e)?super.receive(t):n&&Ct.warn("Message received while socket was closing: "+t))}stop(){return this.stopped=!0,void 0!==this.socket&&this.socket.close(),Promise.resolve()}static discover(){return Ct.warn("Discovery not available for WebSocket client"),Promise.resolve([])}}var Mt=function(t){return 0===t.length},qt=function t(e,n){return void 0===n?function(n){return t(e,n)}:function(t,e){return t<0||t>=e.length}(e,n)?$:E(n[e])},Lt=r((function(t){!function(e,n){"function"==typeof o?t.exports=n():e.pluralize=n()}(i,(function(){var t=[],e=[],n={},r={},i={};function o(t){return"string"==typeof t?new RegExp("^"+t+"$","i"):t}function s(t,e){return t===e?e:t===t.toLowerCase()?e.toLowerCase():t===t.toUpperCase()?e.toUpperCase():t[0]===t[0].toUpperCase()?e.charAt(0).toUpperCase()+e.substr(1).toLowerCase():e.toLowerCase()}function a(t,e){return t.replace(/\$(\d{1,2})/g,(function(t,n){return e[n]||""}))}function u(t,e){return t.replace(e[0],(function(n,r){var i=a(e[1],arguments);return s(""===n?t[r-1]:n,i)}))}function c(t,e,r){if(!t.length||n.hasOwnProperty(t))return e;for(var i=r.length;i--;){var o=r[i];if(o[0].test(e))return u(e,o)}return e}function h(t,e,n){return function(r){var i=r.toLowerCase();return e.hasOwnProperty(i)?s(r,i):t.hasOwnProperty(i)?s(r,t[i]):c(i,r,n)}}function l(t,e,n){return function(r){var i=r.toLowerCase();return!!e.hasOwnProperty(i)||!t.hasOwnProperty(i)&&c(i,i,n)===i}}function f(t,e,n){return(n?e+" ":"")+(1===e?f.singular(t):f.plural(t))}return f.plural=h(i,r,t),f.isPlural=l(i,r,t),f.singular=h(r,i,e),f.isSingular=l(r,i,e),f.addPluralRule=function(e,n){t.push([o(e),n])},f.addSingularRule=function(t,n){e.push([o(t),n])},f.addUncountableRule=function(t){"string"!=typeof t?(f.addPluralRule(t,"$0"),f.addSingularRule(t,"$0")):n[t.toLowerCase()]=!0},f.addIrregularRule=function(t,e){e=e.toLowerCase(),t=t.toLowerCase(),i[t]=e,r[e]=t},[["I","we"],["me","us"],["he","they"],["she","they"],["them","them"],["myself","ourselves"],["yourself","yourselves"],["itself","themselves"],["herself","themselves"],["himself","themselves"],["themself","themselves"],["is","are"],["was","were"],["has","have"],["this","these"],["that","those"],["echo","echoes"],["dingo","dingoes"],["volcano","volcanoes"],["tornado","tornadoes"],["torpedo","torpedoes"],["genus","genera"],["viscus","viscera"],["stigma","stigmata"],["stoma","stomata"],["dogma","dogmata"],["lemma","lemmata"],["schema","schemata"],["anathema","anathemata"],["ox","oxen"],["axe","axes"],["die","dice"],["yes","yeses"],["foot","feet"],["eave","eaves"],["goose","geese"],["tooth","teeth"],["quiz","quizzes"],["human","humans"],["proof","proofs"],["carve","carves"],["valve","valves"],["looey","looies"],["thief","thieves"],["groove","grooves"],["pickaxe","pickaxes"],["passerby","passersby"]].forEach((function(t){return f.addIrregularRule(t[0],t[1])})),[[/s?$/i,"s"],[/[^\u0000-\u007F]$/i,"$0"],[/([^aeiou]ese)$/i,"$1"],[/(ax|test)is$/i,"$1es"],[/(alias|[^aou]us|t[lm]as|gas|ris)$/i,"$1es"],[/(e[mn]u)s?$/i,"$1s"],[/([^l]ias|[aeiou]las|[ejzr]as|[iu]am)$/i,"$1"],[/(alumn|syllab|vir|radi|nucle|fung|cact|stimul|termin|bacill|foc|uter|loc|strat)(?:us|i)$/i,"$1i"],[/(alumn|alg|vertebr)(?:a|ae)$/i,"$1ae"],[/(seraph|cherub)(?:im)?$/i,"$1im"],[/(her|at|gr)o$/i,"$1oes"],[/(agend|addend|millenni|dat|extrem|bacteri|desiderat|strat|candelabr|errat|ov|symposi|curricul|automat|quor)(?:a|um)$/i,"$1a"],[/(apheli|hyperbat|periheli|asyndet|noumen|phenomen|criteri|organ|prolegomen|hedr|automat)(?:a|on)$/i,"$1a"],[/sis$/i,"ses"],[/(?:(kni|wi|li)fe|(ar|l|ea|eo|oa|hoo)f)$/i,"$1$2ves"],[/([^aeiouy]|qu)y$/i,"$1ies"],[/([^ch][ieo][ln])ey$/i,"$1ies"],[/(x|ch|ss|sh|zz)$/i,"$1es"],[/(matr|cod|mur|sil|vert|ind|append)(?:ix|ex)$/i,"$1ices"],[/\b((?:tit)?m|l)(?:ice|ouse)$/i,"$1ice"],[/(pe)(?:rson|ople)$/i,"$1ople"],[/(child)(?:ren)?$/i,"$1ren"],[/eaux$/i,"$0"],[/m[ae]n$/i,"men"],["thou","you"]].forEach((function(t){return f.addPluralRule(t[0],t[1])})),[[/s$/i,""],[/(ss)$/i,"$1"],[/(wi|kni|(?:after|half|high|low|mid|non|night|[^\w]|^)li)ves$/i,"$1fe"],[/(ar|(?:wo|[ae])l|[eo][ao])ves$/i,"$1f"],[/ies$/i,"y"],[/\b([pl]|zomb|(?:neck|cross)?t|coll|faer|food|gen|goon|group|lass|talk|goal|cut)ies$/i,"$1ie"],[/\b(mon|smil)ies$/i,"$1ey"],[/\b((?:tit)?m|l)ice$/i,"$1ouse"],[/(seraph|cherub)im$/i,"$1"],[/(x|ch|ss|sh|zz|tto|go|cho|alias|[^aou]us|t[lm]as|gas|(?:her|at|gr)o|[aeiou]ris)(?:es)?$/i,"$1"],[/(analy|diagno|parenthe|progno|synop|the|empha|cri|ne)(?:sis|ses)$/i,"$1sis"],[/(movie|twelve|abuse|e[mn]u)s$/i,"$1"],[/(test)(?:is|es)$/i,"$1is"],[/(alumn|syllab|vir|radi|nucle|fung|cact|stimul|termin|bacill|foc|uter|loc|strat)(?:us|i)$/i,"$1us"],[/(agend|addend|millenni|dat|extrem|bacteri|desiderat|strat|candelabr|errat|ov|symposi|curricul|quor)a$/i,"$1um"],[/(apheli|hyperbat|periheli|asyndet|noumen|phenomen|criteri|organ|prolegomen|hedr|automat)a$/i,"$1on"],[/(alumn|alg|vertebr)ae$/i,"$1a"],[/(cod|mur|sil|vert|ind)ices$/i,"$1ex"],[/(matr|append)ices$/i,"$1ix"],[/(pe)(rson|ople)$/i,"$1rson"],[/(child)ren$/i,"$1"],[/(eau)x?$/i,"$1"],[/men$/i,"man"]].forEach((function(t){return f.addSingularRule(t[0],t[1])})),["adulthood","advice","agenda","aid","aircraft","alcohol","ammo","analytics","anime","athletics","audio","bison","blood","bream","buffalo","butter","carp","cash","chassis","chess","clothing","cod","commerce","cooperation","corps","debris","diabetes","digestion","elk","energy","equipment","excretion","expertise","firmware","flounder","fun","gallows","garbage","graffiti","hardware","headquarters","health","herpes","highjinks","homework","housework","information","jeans","justice","kudos","labour","literature","machinery","mackerel","mail","media","mews","moose","music","mud","manga","news","only","personnel","pike","plankton","pliers","police","pollution","premises","rain","research","rice","salmon","scissors","series","sewage","shambles","shrimp","software","species","staff","swine","tennis","traffic","transportation","trout","tuna","wealth","welfare","whiting","wildebeest","wildlife","you",/pok[e√©]mon$/i,/[^aeiou]ese$/i,/deer$/i,/fish$/i,/measles$/i,/o[iu]s$/i,/pox$/i,/sheep$/i].forEach(f.addUncountableRule),f}))})),zt=function(){return(zt=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},Ft=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r},_t=function(t,e,n){if(void 0===n&&(n=!1),!t||!e||"object"!=typeof t||"object"!=typeof e)return t;var r=zt({},t);for(var i in e)e.hasOwnProperty(i)&&(r[i]=e[i]instanceof Array&&t[i]instanceof Array?n?Ft(t[i],e[i]):e[i]:"object"==typeof e[i]&&"object"==typeof t[i]?_t(t[i],e[i],n):e[i]);return r},Jt=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r},Bt={defaults:{},errorType:null,polyfills:{fetch:null,FormData:null,URLSearchParams:null,performance:null,PerformanceObserver:null,AbortController:null},polyfill:function(t,e){for(var n=void 0===e?{}:e,r=n.doThrow,i=void 0===r||r,o=n.instance,s=void 0!==o&&o,a=[],u=2;u<arguments.length;u++)a[u-2]=arguments[u];var c=this.polyfills[t]||("undefined"!=typeof self?self[t]:null)||("undefined"!=typeof global?global[t]:null);if(i&&!c)throw new Error(t+" is not defined");return s&&c?new(c.bind.apply(c,Jt([void 0],a))):c}},Wt=function(t,e,n,r){if(!t.getEntriesByName)return!1;var i=t.getEntriesByName(e);return!!(i&&i.length>0)&&(n(i.reverse()[0]),r.clearMeasures&&r.clearMeasures(e),Gt.callbacks.delete(e),Gt.callbacks.size<1&&(Gt.observer.disconnect(),r.clearResourceTimings&&r.clearResourceTimings()),!0)},Gt={callbacks:new Map,observer:null,observe:function(t,e){if(t&&e){var n=Bt.polyfill("performance",{doThrow:!1});(function(t,e){return!Gt.observer&&t&&e&&(Gt.observer=new e((function(e){Gt.callbacks.forEach((function(n,r){Wt(e,r,n,t)}))})),t.clearResourceTimings&&t.clearResourceTimings()),Gt.observer})(n,Bt.polyfill("PerformanceObserver",{doThrow:!1}))&&(Wt(n,t,e,n)||(Gt.callbacks.size<1&&Gt.observer.observe({entryTypes:["resource","measure"]}),Gt.callbacks.set(t,e)))}}},Ht=function(t){this.error=t},Vt=function(){return(Vt=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},Kt=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r},Xt=function(){function t(t,e,n,r,i,o){void 0===n&&(n=new Map),void 0===r&&(r=[]),void 0===i&&(i=[]),void 0===o&&(o=[]),this._url=t,this._options=e,this._catchers=n,this._resolvers=r,this._middlewares=i,this._deferredChain=o}return t.factory=function(e,n){return void 0===e&&(e=""),void 0===n&&(n={}),new t(e,n)},t.prototype.selfFactory=function(e){var n=void 0===e?{}:e,r=n.url,i=n.options,o=n.catchers,s=void 0===o?this._catchers:o,a=n.resolvers,u=void 0===a?this._resolvers:a,c=n.middlewares,h=void 0===c?this._middlewares:c,l=n.deferredChain,f=void 0===l?this._deferredChain:l;return new t(void 0===r?this._url:r,Vt({},void 0===i?this._options:i),new Map(s),Kt(u),Kt(h),Kt(f))},t.prototype.defaults=function(t,e){return void 0===e&&(e=!1),Bt.defaults=e?_t(Bt.defaults,t):t,this},t.prototype.errorType=function(t){return Bt.errorType=t,this},t.prototype.polyfills=function(t){return Bt.polyfills=Vt(Vt({},Bt.polyfills),t),this},t.prototype.url=function(t,e){if(void 0===e&&(e=!1),e)return this.selfFactory({url:t});var n=this._url.split("?");return this.selfFactory({url:n.length>1?n[0]+t+"?"+n[1]:this._url+t})},t.prototype.options=function(t,e){return void 0===e&&(e=!0),this.selfFactory({options:e?_t(this._options,t):t})},t.prototype.query=function(t,e){return void 0===e&&(e=!1),this.selfFactory({url:Yt(this._url,t,e)})},t.prototype.headers=function(t){return this.selfFactory({options:_t(this._options,{headers:t||{}})})},t.prototype.accept=function(t){return this.headers({Accept:t})},t.prototype.content=function(t){var e;return this.headers(((e={})["Content-Type"]=t,e))},t.prototype.auth=function(t){return this.headers({Authorization:t})},t.prototype.catcher=function(t,e){var n=new Map(this._catchers);return n.set(t,e),this.selfFactory({catchers:n})},t.prototype.signal=function(t){return this.selfFactory({options:Vt(Vt({},this._options),{signal:t.signal})})},t.prototype.resolve=function(t,e){return void 0===e&&(e=!1),this.selfFactory({resolvers:e?[t]:Kt(this._resolvers,[t])})},t.prototype.defer=function(t,e){return void 0===e&&(e=!1),this.selfFactory({deferredChain:e?[t]:Kt(this._deferredChain,[t])})},t.prototype.middlewares=function(t,e){return void 0===e&&(e=!1),this.selfFactory({middlewares:e?t:Kt(this._middlewares,t)})},t.prototype.method=function(t,e,n){void 0===e&&(e={}),void 0===n&&(n=null);var r=this._options.headers,i=n?"object"!=typeof n||r&&!Object.entries(r).every((function(t){var e=t[1];return t[0].toLowerCase()!=="Content-Type".toLowerCase()||"application/json"===e}))?this.body(n):this.json(n):this;return function(t){var e=t._url,n=t._resolvers,r=t._middlewares,i=t._options,o=new Map(t._catchers),s=_t(Bt.defaults,i),a=Bt.polyfill("AbortController",{doThrow:!1,instance:!0});!s.signal&&a&&(s.signal=a.signal);var u={ref:null,clear:function(){u.ref&&(clearTimeout(u.ref),u.ref=null)}},c=function(t){return function(e){return 0===t.length?e:1===t.length?t[0](e):t.reduceRight((function(n,r,i){return r(i===t.length-2?n(e):n)}))}}(r)(Bt.polyfill("fetch"))(e,s),h=c.catch((function(t){throw new Ht(t)})).then((function(t){return u.clear(),t.ok?t:t[Bt.errorType||"text"]().then((function(e){var n=new Error(e);throw n[Bt.errorType||"text"]=e,n.status=t.status,n.response=t,n}))})),l=function(e){return function(n){return(e?h.then((function(t){return t&&t[e]()})).then((function(t){return n?n(t):t})):h.then((function(t){return n?n(t):t}))).catch((function(e){u.clear();var n=e instanceof Ht?e.error:e;if(e instanceof Ht&&o.has("__fromFetch"))return o.get("__fromFetch")(n,t);if(o.has(n.status))return o.get(n.status)(n,t);if(o.has(n.name))return o.get(n.name)(n,t);throw n}))}},f={res:l(null),json:l("json"),blob:l("blob"),formData:l("formData"),arrayBuffer:l("arrayBuffer"),text:l("text"),perfs:function(t){return c.then((function(e){return Gt.observe(e.url,t)})),f},setTimeout:function(t,e){return void 0===e&&(e=a),u.clear(),u.ref=setTimeout((function(){return e.abort()}),t),f},controller:function(){return[a,f]},error:function(t,e){return o.set(t,e),f},badRequest:function(t){return f.error(400,t)},unauthorized:function(t){return f.error(401,t)},forbidden:function(t){return f.error(403,t)},notFound:function(t){return f.error(404,t)},timeout:function(t){return f.error(408,t)},internalError:function(t){return f.error(500,t)},fetchError:function(t){return f.error("__fromFetch",t)},onAbort:function(t){return f.error("AbortError",t)}};return n.reduce((function(e,n){return n(e,t)}),f)}((i=i.options(Vt(Vt({},e),{method:t})))._deferredChain.reduce((function(t,e){return e(t,t._url,t._options)}),i))},t.prototype.get=function(t){return this.method("GET",t)},t.prototype.delete=function(t){return this.method("DELETE",t)},t.prototype.put=function(t,e){return this.method("PUT",e,t)},t.prototype.post=function(t,e){return this.method("POST",e,t)},t.prototype.patch=function(t,e){return this.method("PATCH",e,t)},t.prototype.head=function(t){return this.method("HEAD",t)},t.prototype.opts=function(t){return this.method("OPTIONS",t)},t.prototype.replay=function(t){return this.method(this._options.method,t)},t.prototype.body=function(t){return this.selfFactory({options:Vt(Vt({},this._options),{body:t})})},t.prototype.json=function(t){return this.content("application/json").body(JSON.stringify(t))},t.prototype.formData=function(t,e){return void 0===e&&(e=!1),this.body(Qt(t,e))},t.prototype.formUrl=function(t){return this.body("string"==typeof t?t:(e=t,Object.keys(e).map((function(t){var n=e[t];return n instanceof Array?n.map((function(e){return Zt(t,e)})).join("&"):Zt(t,n)})).join("&"))).content("application/x-www-form-urlencoded");var e},t}(),Yt=function(t,e,n){var r;if("string"==typeof e)r=e;else{var i=Bt.polyfill("URLSearchParams",{instance:!0});for(var o in e)if(e[o]instanceof Array)for(var s=0,a=e[o];s<a.length;s++)i.append(o,a[s]);else i.append(o,e[o]);r=i.toString()}var u=t.split("?");return n||u.length<2?u[0]+"?"+r:t+"&"+r};function Qt(t,e,n,r){return void 0===e&&(e=!1),void 0===n&&(n=Bt.polyfill("FormData",{instance:!0})),void 0===r&&(r=[]),Object.entries(t).forEach((function(t){var i=t[0],o=t[1],s=r.reduce((function(t,e){return t?t+"["+e+"]":e}),null);if(s=s?s+"["+i+"]":i,o instanceof Array)for(var a=0,u=o;a<u.length;a++)n.append(s+"[]",u[a]);else!e||"object"!=typeof o||e instanceof Array&&e.includes(i)?n.append(s,o):null!==o&&Qt(o,e,n,Kt(r,[i]))})),n}function Zt(t,e){return encodeURIComponent(t)+"="+encodeURIComponent("object"==typeof e?JSON.stringify(e):""+e)}var te,ee=Xt.factory;ee.default=Xt.factory,function(t){t.WAITING="WAITING",t.DISPATCHED="DISPATCHED",t.PENDING="PENDING",t.RECEIVED="RECEIVED",t.STARTED="STARTED",t.SUCCESS="SUCCESS",t.FAILURE="FAILURE",t.CANCELLED="CANCELLED",t.REVOKED="REVOKED",t.TERMINATED="TERMINATED",t.RUNNING="RUNNING"}(te||(te={}));const ne={keepChecking:[te.WAITING,te.DISPATCHED,te.PENDING,te.RECEIVED,te.STARTED],stopChecking:[te.SUCCESS,te.FAILURE,te.CANCELLED,te.REVOKED,te.TERMINATED],readyToExecute:[te.RUNNING]},re=t=>null!==t.url&&ne.readyToExecute.includes(t.status),ie=ee().options({credentials:"include"}),oe=t=>void 0===t?Promise.resolve(_(new Error("No Job Url to connect to"))):l.pipe(t,(async t=>(t=>ne.stopChecking.includes(t.status)?_(t):ne.readyToExecute.includes(t.status)?re(t)?F(t):_(t):X((t=>ne.stopChecking.includes(t.status))(t)?_(t):F(t)))(await(t=>ie.url(t).get().json((t=>t)))(t)))),se=t=>(t=>!(t instanceof Error))(t)?t.statusMessage:"An unexpected error occurred",ae=({session:e,job:n},r)=>t("span",{class:{executableDocumentStatus:!0,danger:V(e),success:H(e)}},l.pipe(e,Y((()=>""),(()=>t("span",null,t("stencila-icon",{icon:"loader-2"}),t("span",null,l.pipe(n,Y((()=>"Requesting session"),(()=>"Requesting session"),se,(t=>t.statusMessage),se,(t=>t.statusMessage)))))),(e=>t("span",null,t("stencila-icon",{icon:"loader-2"}),t("span",null,se(e)))),(e=>t("span",null,Mt(r)?[t("stencila-icon",{icon:"loader-2"}),e.status]:t("span",null,r))),(e=>t("span",null,t("stencila-icon",{icon:"error-warning"}),t("span",null,se(e)))),(()=>t("stencila-tooltip",{text:"Compute session is active"},t("stencila-icon",{icon:"pulse"}),Mt(r)?null:t("span",null,r)))))),ue=a({position:u.topCenter}),ce=()=>ue.present("Couldn‚Äôt start a compute session",{type:s.danger}),he=class{constructor(n){e(this,n),this.jobPoller=void 0,this.jobPollFrequency=3e3,this.requestController=new AbortController,this.requestSignal=this.requestController.signal,this.initAbortControllers=()=>{this.requestController=new AbortController,this.requestSignal=this.requestController.signal},this.position="fixed",this.session=J,this.job=J,this.executor=null,this.codeCount=0,this.statusMessage="",this.checkJobStatus=async()=>O(this.job)?this.job:(this.job=K(this.job),oe(this.jobUrl)),this.handleJobStatus=(t,e,n)=>l.pipe(t,Y((()=>(this.jobPoller=this.pollJobFn(this.jobPollFrequency,e,n),B)),(()=>t),(()=>t),(()=>t),(e=>{var n;return window.clearInterval(this.jobPoller),this.requestController.abort(),null===(n=this.executor)||void 0===n||n.stop().catch((t=>{console.warn("Failed to stop Executa",t)})),this.session=_(e),t}),(n=>(re(n)&&(window.clearInterval(this.jobPoller),this.jobPoller=this.pollJobFn(1e4),e&&e(this.startExecutor(n.url))),t))),(t=>(this.job=t,t))),this.pollJob=(t,e)=>this.checkJobStatus().then((n=>this.handleJobStatus(n,t,e))).catch((t=>this.handleJobStatus(_(t)))),this.pollJobFn=(t=this.jobPollFrequency,e,n)=>window.setInterval((()=>{this.pollJob(e,n).catch((t=>_(t)))}),t),this.findSession=async()=>void 0===this.sessionProviderUrl?_(new Error("Please set a SessionProviderUrl")):"Initial"===this.session._tag||V(this.session)?(this.session=B,ie.url(this.sessionProviderUrl).post().res((t=>{this.jobUrl=t.url})).then((()=>new Promise(((t,e)=>this.handleJobStatus(J,t,e))))).catch((t=>{throw ce(),this.session=_(t),t}))):Promise.resolve(this.session),this.startExecutor=async t=>{const e=new Ut(t);return this.executor=e,this.session=await e.begin(c()).then((t=>(ue.present("Ready to run document",{type:s.success}),F(t)))).catch((t=>(ce(),_(new Error(t))))),this.session},this.codeNodeSelector=()=>[...Array.from(document.querySelectorAll("stencila-code-chunk, stencila-code-expression"))],this.executeHandler=async t=>{if(k(this.session))return ue.present("Please wait until a compute session is found",{type:s.warn}),t;const e=e=>{var n;return Object.assign(Object.assign({},t),{errors:[...null!==(n=t.errors)&&void 0!==n?n:[],h({errorType:"error",errorMessage:"Could not run "+("CodeChunk"===t.type?"code chunk":"code expression"),stackTrace:e})]})};return this.findSession().then((()=>this.executor&&H(this.session)?this.executor.execute(t,this.session.value.right).catch((t=>(console.error(t),e(t)))):e("Couldn‚Äôt start a compute session"))).catch((t=>e(t)))},this.runAll=async t=>(t.preventDefault(),this.initAbortControllers(),new Promise(((t,e)=>{this.requestSignal.addEventListener("abort",e),this.findSession().then((async()=>{const n=[];let r=0;this.session=K(this.session);for(const t of this.codeNodeSelector()){this.activeNodeIndex=r,this.statusMessage=`${++r} of ${this.codeCount} code ${Lt("node",this.codeCount)}`;const e=await t.execute();n.push(e),r>=this.codeCount&&(this.statusMessage="")}return this.session=X(this.session),this.requestSignal.removeEventListener("abort",e),t(n)})).catch((t=>{this.requestSignal.removeEventListener("abort",e),e(t)}))}))),this.goToActiveNode=()=>{var t,e;l.pipe(this.codeNodeSelector(),qt(null!==(t=this.activeNodeIndex)&&void 0!==t?t:-1),(e=t=>{var e;const n=document.querySelector("stencila-executable-document-toolbar"),r=null!==(e=null==n?void 0:n.getBoundingClientRect().height)&&void 0!==e?e:0,i=t.getBoundingClientRect().top-r+window.pageYOffset;window.scrollTo({top:i,behavior:"smooth"})},function(t){return function(t,e){return function(t){return"None"===t._tag}(t)?$:E(e(t.value))}(t,e)}))},this.executionProgress=()=>t("stencila-tooltip",{text:"Jump to location",onClick:this.goToActiveNode},t("stencila-icon",{icon:"focus-3"}),t("span",null,this.statusMessage))}componentWillLoad(){const t=this.codeNodeSelector();this.codeCount=t.length,t.map((t=>{t.executeHandler=this.executeHandler}))}render(){return t(n,{position:this.position},t("stencila-toolbar",null,t("span",{slot:"start"},t("stencila-button",{color:"stock",icon:"play",size:"small",onClick:this.runAll,disabled:this.codeCount<=0,tooltip:this.codeCount<=0?"No code nodes in the document to execute":void 0,isLoading:k(this.session)||O(this.session),dataEl:"Toolbar/Run Document"},k(this.session)||O(this.session)?"Running":["Run",t("span",{class:"hidden-sm"}," Document")])),t("span",{slot:"middle"},t(ae,{job:this.job,session:this.session},O(this.session)&&this.executionProgress())),void 0!==this.sourceUrl&&t("span",{slot:"end"},t("stencila-button",{color:"stock",href:this.sourceUrl,target:"_blank",rel:"nofollow noopener",icon:"external-link",size:"small",dataEl:"Toolbar/Project Source"},"Source"))))}};he.style={default:":host,stencila-executable-document-toolbar{--background:var(--color-neutral-300);display:block}:host([position=fixed]),stencila-executable-document-toolbar[position=fixed]{position:fixed;top:0;left:0;z-index:30;width:100%;max-width:none!important}:host([position=fixed])+*,stencila-executable-document-toolbar[position=fixed]+*{margin-top:3rem}:host .hidden-sm,stencila-executable-document-toolbar .hidden-sm{display:none}@media (min-width:640px){:host .hidden-sm,stencila-executable-document-toolbar .hidden-sm{display:inline}}:host .executableDocumentStatus,stencila-executable-document-toolbar .executableDocumentStatus{font-size:.875rem;line-height:1;color:#000;color:var(--color-key,#000)}:host .executableDocumentStatus.success,stencila-executable-document-toolbar .executableDocumentStatus.success{color:#2f855a;color:var(--color-success-700,#2f855a)}:host .executableDocumentStatus.danger,stencila-executable-document-toolbar .executableDocumentStatus.danger{color:#f56565;color:var(--color-danger-500,#f56565)}:host .executableDocumentStatus stencila-icon,stencila-executable-document-toolbar .executableDocumentStatus stencila-icon{margin-right:.25rem}:host .executableDocumentStatus stencila-tooltip,stencila-executable-document-toolbar .executableDocumentStatus stencila-tooltip{cursor:help}:host .executableDocumentStatus span,stencila-executable-document-toolbar .executableDocumentStatus span{vertical-align:middle}",material:":host,stencila-executable-document-toolbar{--background:var(--color-neutral-300);display:block}:host([position=fixed]),stencila-executable-document-toolbar[position=fixed]{position:fixed;top:0;left:0;z-index:30;width:100%;max-width:none!important}:host([position=fixed])+*,stencila-executable-document-toolbar[position=fixed]+*{margin-top:3rem}:host .hidden-sm,stencila-executable-document-toolbar .hidden-sm{display:none}@media (min-width:640px){:host .hidden-sm,stencila-executable-document-toolbar .hidden-sm{display:inline}}:host .executableDocumentStatus,stencila-executable-document-toolbar .executableDocumentStatus{font-size:.875rem;line-height:1;color:#000;color:var(--color-key,#000)}:host .executableDocumentStatus.success,stencila-executable-document-toolbar .executableDocumentStatus.success{color:#2f855a;color:var(--color-success-700,#2f855a)}:host .executableDocumentStatus.danger,stencila-executable-document-toolbar .executableDocumentStatus.danger{color:#f56565;color:var(--color-danger-500,#f56565)}:host .executableDocumentStatus stencila-icon,stencila-executable-document-toolbar .executableDocumentStatus stencila-icon{margin-right:.25rem}:host .executableDocumentStatus stencila-tooltip,stencila-executable-document-toolbar .executableDocumentStatus stencila-tooltip{cursor:help}:host .executableDocumentStatus span,stencila-executable-document-toolbar .executableDocumentStatus span{vertical-align:middle}"};export{he as stencila_executable_document_toolbar}